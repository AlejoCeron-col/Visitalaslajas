<%- include("../components/header.ejs", { titulo , ocultarbtnreg, ocultarbtnini }) %>

    <main class="consre">
      <div class="consulta">
        <h2>Consulta tu reserva</h2>
        <form id="form-consulta" class="form-reserva">
          <div class="form-group">
            <input class="inpce" type="text" id="cedula-consulta" name="cedula" required placeholder="Ingresa tu numero de cedula">
          </div>
          <button type="submit" class="btn-consultar">Consultar Reserva</button>
        </form>
        <div id="mensaje-consulta" class="mencon"></div>
        <div class="map-container">
            <div id="mapa"></div>
            <div id="mapa-mensaje" class="mapa-mensaje">
              <p>Ingresa tu numero de cedula para ver los lugares de tu reserva en el mapa.</p>
            </div>
        </div>
      </div>

      
      <div class="panellugares" id="panel-lugares" style="display: none;">
         <h2 class="sec2">Lugares Seleccionados</h2>
         <div id="lugares-reserva" class="lugares"></div>
       </div>
      
      

      <div class="panel" id="panel-reserva" style="display: none;">
        <h2>Datos de la Reserva</h2>
        <div id="datos-reserva" class="datos-reserva"></div>
      </div>

      
    </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <script>
    
    const mapa = L.map('mapa').setView([0.8150, -77.6200], 13);


    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mapa);

    let marcadores = [];
    let routingControl = null;


    function crearMarcador(lat, lng, color, icono, nombre, descripcion) {
      const markerHtml = `
        <img style="
          background: ${color};
          width: 36px;
          height: 36px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
          border: 3px solid white;
        " src="${icono}"></div>
      `;

      const icon = L.divIcon({
        html: markerHtml,
        className: 'custom-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      const marker = L.marker([lat, lng], { icon })
        .bindPopup(`
          <div class="popup-content">
            <h4>${nombre}</h4>
            <p>${descripcion}</p>
          </div>
        `);

      return marker;
    }


    function limpiarMapa() {
      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];
      if (routingControl) {
        mapa.removeControl(routingControl);
        routingControl = null;
      }
    }


    function mostrarLugaresEnMapa(lugares) {
      limpiarMapa();
      document.getElementById('mapa-mensaje').style.display = 'none';

      lugares.forEach(lugar => {
        const marker = crearMarcador(
          lugar.coordenadas[0],
          lugar.coordenadas[1],
          lugar.color,
          lugar.icono,
          lugar.nombre,
          lugar.descripcion
        );
        marker.addTo(mapa);
        marcadores.push(marker);
      });

      if (lugares.length >= 2) {
        const waypoints = lugares.map(l => L.latLng(l.coordenadas[0], l.coordenadas[1]));
        
        try {
          routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            showAlternatives: false,
            createMarker: function() { return null; },
            lineOptions: {
              styles: [
                { color: '#059669', weight: 5, opacity: 0.8 },
                { color: '#10b981', weight: 3, opacity: 0.5 }
              ]
            },
            router: L.Routing.osrmv1({
              serviceUrl: 'https://router.project-osrm.org/route/v1'
            })
          }).addTo(mapa);
        } catch (error) {

          L.polyline(waypoints, {
            color: '#059669',
            weight: 4,
            opacity: 0.7,
            dashArray: '10, 10'
          }).addTo(mapa);
        }
      }


      if (lugares.length === 1) {
        mapa.setView(lugares[0].coordenadas, 15);
      } else if (lugares.length > 1) {
        const bounds = L.latLngBounds(lugares.map(l => l.coordenadas));
        mapa.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    function mostrarDatosReserva(reserva) {
      const panelReserva = document.getElementById('panel-reserva');
      const datosReserva = document.getElementById('datos-reserva');
      const panelLugares = document.getElementById('panel-lugares');
      const lugaresReserva = document.getElementById('lugares-reserva');

      const fechaVisita = reserva.fechaVisita 
        ? new Date(reserva.fechaVisita).toLocaleDateString('es-CO', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })
        : 'No especificada';

      const fechaCreacion = new Date(reserva.fechaCreacion).toLocaleDateString('es-CO', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      datosReserva.innerHTML = `
        <div class="dato-item">
          <span class="dato-label">Cedula:</span>
          <span class="dato-valor">${reserva.cedula}</span>
        </div>
        <div class="dato-item">
          <span class="dato-label">Nombre:</span>
          <span class="dato-valor">${reserva.nombre}</span>
        </div>
        ${reserva.email ? `
        <div class="dato-item">
          <span class="dato-label">Email:</span>
          <span class="dato-valor">${reserva.email}</span>
        </div>
        ` : ''}
        ${reserva.telefono ? `
        <div class="dato-item">
          <span class="dato-label">Telefono:</span>
          <span class="dato-valor">${reserva.telefono}</span>
        </div>
        ` : ''}
        <div class="dato-item">
          <span class="dato-label">Fecha de visita:</span>
          <span class="dato-valor">${fechaVisita}</span>
        </div>
        <div class="dato-item">
          <span class="dato-label">Reserva creada:</span>
          <span class="dato-valor">${fechaCreacion}</span>
        </div>
        ${reserva.guiaInfo ? `
        <div class="dato-item guia-info">
          <span class="dato-label">Guía asignado:</span>
          <span class="dato-valor">
            <img src="${reserva.guiaInfo.foto}" alt="${reserva.guiaInfo.nombre}" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:8px;"> ${reserva.guiaInfo.nombre}
            <span style="margin-left:10px;color:#f59e0b;">${'★'.repeat(reserva.guiaInfo.rating)}${'☆'.repeat(5 - reserva.guiaInfo.rating)}</span>
          </span>
        </div>
        ` : ''}
      `;

      // Mostrar lugares seleccionados
      lugaresReserva.innerHTML = reserva.lugaresInfo.map(lugar => `
        <div class="lugar-item2 ">
          <div class="lugar-nombre">${lugar.nombre}</div>
          <div class="lugar-info">
            <img src="${lugar.icono}" alt="${lugar.nombre}" class="lugar-icon" />
          </div>
        </div>
      `).join('');

      panelReserva.style.display = 'block';
      panelLugares.style.display = 'block';

      // Añadir botón para eliminar reserva
      let eliminarBtn = document.getElementById('btn-eliminar-reserva');
      if (!eliminarBtn) {
        eliminarBtn = document.createElement('button');
        eliminarBtn.id = 'btn-eliminar-reserva';
        eliminarBtn.className = 'btn-eliminar';
        eliminarBtn.textContent = 'Eliminar reserva';
        datosReserva.parentElement.appendChild(eliminarBtn);
      }
      // Guardar id de reserva en el botón
      eliminarBtn.dataset.reservaId = reserva.id;
      eliminarBtn.addEventListener('click', function() {
        const id = this.dataset.reservaId;
        openConfirmModal(id);
      });

      // Mostrar lugares en el mapa
      mostrarLugaresEnMapa(reserva.lugaresInfo);
    }

    // Manejar formulario de consulta
    document.getElementById('form-consulta').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const cedula = document.getElementById('cedula-consulta').value.trim();
      const mensajeConsulta = document.getElementById('mensaje-consulta');

      if (!cedula) {
        mensajeConsulta.innerHTML = `
          <div class="mensaje error">Ingresa un numero de cedula.</div>
        `;
        return;
      }

      mensajeConsulta.innerHTML = `
        <div class="mensaje info">Buscando reserva...</div>
      `;

      try {
        const response = await fetch(`/api/reservas/${encodeURIComponent(cedula)}`);
        const resultado = await response.json();

        if (response.ok) {
          mensajeConsulta.innerHTML = `
            <div class="mensaje exito">Reserva encontrada</div>
          `;
          mostrarDatosReserva(resultado);
        } else {
          mensajeConsulta.innerHTML = `
            <div class="mensaje error">${resultado.error}</div>
          `;
          document.getElementById('panel-reserva').style.display = 'none';
          document.getElementById('panel-lugares').style.display = 'none';
          limpiarMapa();
          document.getElementById('mapa-mensaje').style.display = 'flex';
        }
      } catch (error) {
        mensajeConsulta.innerHTML = `
          <div class="mensaje error">Error al consultar. Intenta nuevamente.</div>
        `;
      }
    });
  </script>

  <!-- Modal de confirmación/eliminación -->
  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div id="modal-content">
        <h2 class="modal-title">¿Deseas eliminar esta reserva?</h2>
        <p class="modal-body">Esta acción no se puede deshacer. Confirma si deseas cancelar la reserva.</p>
        <div class="modal-actions">
          <button id="modal-cancel" class="modal-btn modal-cancel">Cancelar</button>
          <button id="modal-confirm" class="modal-btn modal-confirm">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <%- include("../components/footer.ejs") %>

  <script>
    // Modal control functions
    function openConfirmModal(reservaId) {
      const overlay = document.getElementById('modal-overlay');
      overlay.style.display = 'flex';
      const confirmBtn = document.getElementById('modal-confirm');
      const cancelBtn = document.getElementById('modal-cancel');

      function clean() {
        confirmBtn.removeEventListener('click', onConfirm);
        cancelBtn.removeEventListener('click', onCancel);
      }

      async function onConfirm() {
        try {
          const res = await fetch('/api/reservas/' + reservaId, { method: 'DELETE' });
          const json = await res.json();
          if (res.ok) {
  
            document.getElementById('modal-content').innerHTML = `
              <h2 class="modal-title">Se canceló su reserva</h2>
              <div style="height:20px"></div>
              <div class="modal-actions">
                <button id="modal-continue" class="modal-btn modal-confirm">Continuar</button>
              </div>
            `;
        
            document.getElementById('panel-reserva').style.display = 'none';
            document.getElementById('panel-lugares').style.display = 'none';
            limpiarMapa();
            document.getElementById('mapa-mensaje').style.display = 'flex';

            document.getElementById('modal-continue').addEventListener('click', function() {
              document.getElementById('modal-overlay').style.display = 'none';
            });
          } else {
            alert(json.error || 'Error al eliminar');
            overlay.style.display = 'none';
          }
        } catch (err) {
          alert('Error al eliminar la reserva');
          overlay.style.display = 'none';
        } finally {
          clean();
        }
      }

      function onCancel() {
        document.getElementById('modal-overlay').style.display = 'none';
        clean();
      }

      confirmBtn.addEventListener('click', onConfirm);
      cancelBtn.addEventListener('click', onCancel);
    }
  </script>
